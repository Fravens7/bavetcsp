<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Test Supabase Job Posts</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <h1>Ofertas de Trabajo desde Supabase</h1>
  <div id="job-listings"></div>

  <script>
    const supabaseUrl = 'https://hxnikfmwknlxmkqcsrol.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4bmlrZm13a25seG1rcWNzcm9sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1OTUwNTksImV4cCI6MjA3NTE3MTA1OX0.G2b3hFEvpvOFpiFFk_a2os-7mFOgsZz6pj_YMihvv5A';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // Verificar sesión al cargar la página
    document.addEventListener('DOMContentLoaded', async () => {
      const session = supabase.auth.session(); // Obtener la sesión actual
      if (session) {
        console.log('Usuario autenticado:', session.user);
      } else {
        console.log('No hay usuario autenticado');
      }

      loadJobListings();  // Cargar las ofertas de trabajo
    });

    // Controlador de cambio de estado de autenticación
    supabase.auth.onAuthStateChange((event, session) => {
      console.log('Estado de autenticación cambiado:', event);
      if (session && session.user) {
        console.log('Usuario autenticado:', session.user);
      } else {
        console.log('No hay usuario autenticado');
      }
    });

    // Función para cargar las ofertas de trabajo
    async function loadJobListings() {
      const container = document.getElementById('job-listings');
      const { data: jobs, error } = await supabaseClient.from('job_posts').select('*');
      
      if (error) {
        container.innerHTML = `<p>Error al cargar datos: ${error.message}</p>`;
        return;
      }

      if (!jobs || jobs.length === 0) {
        container.innerHTML = '<p>No hay ofertas disponibles.</p>';
        return;
      }

      container.innerHTML = jobs.map(job => `
        <div data-id="${job.id}">
          <h3>${job.title}</h3>
          <p><strong>Departamento:</strong> ${job.department}</p>
          <p><strong>Tipo:</strong> ${job.type}</p>
          <p><strong>Ubicación:</strong> ${job.location}</p>
          <p><strong>Descripción:</strong> ${job.description}</p>

          <h4>Responsabilidades:</h4>
          <ul>
            ${(job.responsibilities || '').split('\n').map(item => `<li>${item.trim()}</li>`).join('')}
          </ul>

          <h4>Requisitos:</h4>
          <ul>
            ${(job.requirements || '').split('\n').map(item => `<li>${item.trim()}</li>`).join('')}
          </ul>

          <h4>Beneficios:</h4>
          <ul>
            ${(job.benefits || '').split('\n').map(item => `<li>${item.trim()}</li>`).join('')}
          </ul>

          <p><strong>Modalidad de trabajo:</strong> ${job.work_setup}</p>

          <button onclick="editJob(${job.id}, '${job.title}', '${job.department}', '${job.type}', '${job.location}', '${job.description}', '${job.responsibilities}', '${job.requirements}', '${job.benefits}', '${job.work_setup}')">Editar</button>
        </div>
      `).join('');
    }

    // Función para editar una oferta de trabajo
    async function editJob(id, title, department, type, location, description, responsibilities, requirements, benefits, work_setup) {
      const formHTML = `
        <h3>Editar Oferta de Trabajo</h3>
        <form id="edit-form">
          <input type="hidden" name="id" value="${id}" />
          <label for="title">Título:</label>
          <input type="text" id="title" name="title" value="${title}" required><br><br>
          
          <label for="department">Departamento:</label>
          <input type="text" id="department" name="department" value="${department}" required><br><br>
          
          <label for="type">Tipo:</label>
          <input type="text" id="type" name="type" value="${type}" required><br><br>
          
          <label for="location">Ubicación:</label>
          <input type="text" id="location" name="location" value="${location}" required><br><br>
          
          <label for="description">Descripción:</label>
          <textarea id="description" name="description" required>${description}</textarea><br><br>
          
          <label for="responsibilities">Responsabilidades:</label>
          <textarea id="responsibilities" name="responsibilities">${responsibilities}</textarea><br><br>
          
          <label for="requirements">Requisitos:</label>
          <textarea id="requirements" name="requirements">${requirements}</textarea><br><br>
          
          <label for="benefits">Beneficios:</label>
          <textarea id="benefits" name="benefits">${benefits}</textarea><br><br>
          
          <label for="work_setup">Modalidad de trabajo:</label>
          <input type="text" id="work_setup" name="work_setup" value="${work_setup}" required><br><br>

          <button type="submit">Guardar cambios</button>
        </form>
      `;

      document.getElementById('job-listings').innerHTML = formHTML;

      // Al enviar el formulario
      document.getElementById('edit-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const user = supabase.auth.user();
        
        if (!user) {
          alert("Por favor, inicia sesión para editar la oferta.");
          return;
        }

        const updates = {
          title: e.target.title.value,
          department: e.target.department.value,
          type: e.target.type.value,
          location: e.target.location.value,
          description: e.target.description.value,
          responsibilities: e.target.responsibilities.value,
          requirements: e.target.requirements.value,
          benefits: e.target.benefits.value,
          work_setup: e.target.work_setup.value,
          user_id: user.id // Asignar el ID del usuario autenticado
        };

        // Realizar la actualización
        const { error } = await supabaseClient
          .from('job_posts')
          .update(updates)
          .eq('id', id)
          .eq('user_id', user.id);  // Asegura que solo el propietario pueda actualizar

        if (error) {
          alert('Error al actualizar la oferta: ' + error.message);
        } else {
          alert('Oferta actualizada correctamente');
          loadJobListings();  // Recargar las ofertas después de la actualización
        }
      });
    }

  </script>

</body>
</html>

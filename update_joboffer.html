<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ofertas de Trabajo desde Supabase</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <h1>Ofertas de Trabajo desde Supabase</h1>
  <div id="job-listings"></div>

  <!-- Formulario de edición oculto inicialmente -->
  <div id="edit-form-container" style="display:none; border: 1px solid #ccc; padding: 15px; margin-top: 20px;">
    <h2>Editar Oferta</h2>
    <form id="edit-form">
      <input type="hidden" name="id" />
      <p><label>Título: <br><input type="text" name="title" required /></label></p>
      <p><label>Departamento: <br><input type="text" name="department" /></label></p>
      <p><label>Tipo: <br><input type="text" name="type" /></label></p>
      <p><label>Ubicación: <br><input type="text" name="location" /></label></p>
      <p><label>Descripción: <br><textarea name="description" rows="3"></textarea></label></p>
      <p><label>Responsabilidades (separar con salto de línea): <br><textarea name="responsibilities" rows="3"></textarea></label></p>
      <p><label>Requisitos (separar con salto de línea): <br><textarea name="requirements" rows="3"></textarea></label></p>
      <p><label>Beneficios (separar con salto de línea): <br><textarea name="benefits" rows="3"></textarea></label></p>
      <p><label>Modalidad de trabajo: <br><input type="text" name="work_setup" /></label></p>

      <button type="submit">Guardar Cambios</button>
      <button type="button" id="cancel-btn">Cancelar</button>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const supabaseUrl = 'https://hxnikfmwknlxmkqcsrol.supabase.co';
      const supabaseKey = 'tu_api_key_aqui'; // Pon tu API key real aquí
      const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

      const container = document.getElementById('job-listings');
      const editFormContainer = document.getElementById('edit-form-container');
      const editForm = document.getElementById('edit-form');
      const cancelBtn = document.getElementById('cancel-btn');

      // Función para cargar y mostrar todas las ofertas
      async function loadJobPosts() {
        try {
          const { data: jobs, error } = await supabaseClient.from('job_posts').select('*');
          if (error) throw error;

          if (!jobs || jobs.length === 0) {
            container.innerHTML = '<p>No hay ofertas disponibles.</p>';
            return;
          }

          container.innerHTML = jobs.map(job => `
            <div style="border:1px solid #ccc; padding: 10px; margin-bottom: 15px;">
              <h3>${job.title}</h3>
              <p><strong>Departamento:</strong> ${job.department}</p>
              <p><strong>Tipo:</strong> ${job.type}</p>
              <p><strong>Ubicación:</strong> ${job.location}</p>
              <p><strong>Descripción:</strong> ${job.description}</p>

              <h4>Responsabilidades:</h4>
              <ul>${(job.responsibilities || '').split('\n').map(item => `<li>${item.trim()}</li>`).join('')}</ul>

              <h4>Requisitos:</h4>
              <ul>${(job.requirements || '').split('\n').map(item => `<li>${item.trim()}</li>`).join('')}</ul>

              <h4>Beneficios:</h4>
              <ul>${(job.benefits || '').split('\n').map(item => `<li>${item.trim()}</li>`).join('')}</ul>

              <p><strong>Modalidad de trabajo:</strong> ${job.work_setup}</p>
              <button data-id="${job.id}" class="edit-btn">Editar</button>
            </div>
          `).join('');

          // Agregar evento a botones editar
          document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', () => {
              const id = button.getAttribute('data-id');
              const job = jobs.find(j => j.id == id);
              openEditForm(job);
            });
          });

        } catch (err) {
          container.innerHTML = `<p>Error al cargar datos: ${err.message}</p>`;
        }
      }

      // Abrir el formulario y precargar datos para editar
      function openEditForm(job) {
        editFormContainer.style.display = 'block';

        editForm.id.value = job.id;
        editForm.title.value = job.title || '';
        editForm.department.value = job.department || '';
        editForm.type.value = job.type || '';
        editForm.location.value = job.location || '';
        editForm.description.value = job.description || '';
        editForm.responsibilities.value = job.responsibilities || '';
        editForm.requirements.value = job.requirements || '';
        editForm.benefits.value = job.benefits || '';
        editForm.work_setup.value = job.work_setup || '';
      }

      // Manejar cancelación de edición
      cancelBtn.addEventListener('click', () => {
        editFormContainer.style.display = 'none';
      });

      // Manejar envío del formulario para actualizar oferta
      editForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = editForm.id.value;
        const updates = {
          title: editForm.title.value,
          department: editForm.department.value,
          type: editForm.type.value,
          location: editForm.location.value,
          description: editForm.description.value,
          responsibilities: editForm.responsibilities.value,
          requirements: editForm.requirements.value,
          benefits: editForm.benefits.value,
          work_setup: editForm.work_setup.value,
        };

        try {
          const { error } = await supabaseClient
            .from('job_posts')
            .update(updates)
            .eq('id', id);

          if (error) throw error;

          alert('Oferta actualizada correctamente.');
          editFormContainer.style.display = 'none';
          loadJobPosts();

        } catch (err) {
          alert('Error al actualizar: ' + err.message);
        }
      });

      // Cargar ofertas al iniciar
      loadJobPosts();
    });
  </script>

</body>
</html>
